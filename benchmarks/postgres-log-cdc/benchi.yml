infrastructure:
  postgres:
    compose: ../../shared/postgres/compose.yml

tools:
  conduit:
    compose:
      - ../../shared/conduit/compose.yml
      - ./conduit/compose.override.yml

metrics:
  conduit_metrics:
    collector: conduit
    tools: conduit
    settings:
      url: http://localhost:8080/metrics
      pipelines: postgres-to-log
  docker_metrics:
    collector: docker
    settings:
      containers:
        - benchi-conduit

tests:
  - name: postgres-to-log-cdc
    duration: 1m

    steps:
      pre-infrastructure:
      post-infrastructure:
      
      pre-tool:
      post-tool:
        - name: "Conduit: Set up CDC"
          tools: conduit
          container: benchi-conduit
          run: |
            /benchi/scripts/install_tools.sh
            /benchi/scripts/start_pipeline.sh postgres-to-log
            /benchi/scripts/stop_pipeline.sh postgres-to-log
        
        - name: "Postgres: Insert test data"
          container: benchi-postgres
          run: /benchi/scripts/insert_test_employees.sh "5000000"
      
      pre-test:
        - name: "Conduit: Start pipeline"
          tools: conduit
          container: benchi-conduit
          run: /benchi/scripts/start_pipeline.sh postgres-to-log

      during:
      post-test:
      pre-cleanup:
      post-cleanup:
